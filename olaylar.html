<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA G√úVENLƒ∞K | Olay Takip Merkezi</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #0a0c10;
        --card-bg: #12151c;
        --accent: #00d2ff;
        --danger: #ff4d4d;
        --warning: #ffcc00;
        --success: #00ff88;
        --text: #e6edf3;
        --text-s: #8b949e;
        --border: rgba(255, 255, 255, 0.08);
    }

    body {
        margin: 0;
        font-family: 'Montserrat', sans-serif;
        background: var(--bg);
        color: var(--text);
        padding: 20px;
        background-image: radial-gradient(circle at top right, rgba(0, 210, 255, 0.05), transparent);
    }

    /* Header & Markalama */
    .header-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 20px;
    }

    h1 {
        margin: 0;
        font-weight: 800;
        letter-spacing: -1px;
        text-transform: uppercase;
        font-size: 1.5rem;
        color: var(--accent);
    }

    h1 span { color: #fff; font-weight: 300; margin-left: 5px; opacity: 0.6; }

    /* Filtre Paneli */
    .filters {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 30px;
        border: 1px solid var(--border);
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .filters select, .filters input {
        background: #0d1117;
        border: 1px solid #30363d;
        color: white;
        padding: 12px;
        border-radius: 12px;
        font-family: 'Montserrat';
        font-size: 13px;
        outline: none;
        transition: 0.3s;
    }

    .filters input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
    }

    #resetFilters {
        background: rgba(255,255,255,0.05);
        color: white;
        border: 1px solid var(--border);
        padding: 10px 20px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
    }

    /* Olay Kartlarƒ± */
    .event-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 25px;
        margin-bottom: 20px;
        transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .event-card:hover {
        transform: translateY(-5px);
        border-color: var(--accent);
        box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }

    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .event-user { 
        font-family: 'JetBrains Mono'; 
        color: var(--accent); 
        background: rgba(0, 210, 255, 0.1);
        padding: 5px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
    }

    .event-type {
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 1px;
        padding: 6px 14px;
        border-radius: 30px;
    }

    /* T√ºr Renkleri */
    .Hirsizlik { background: rgba(231, 76, 60, 0.1); color: #ff4d4d; border: 1px solid rgba(231, 76, 60, 0.2); }
    .Yangin { background: rgba(211, 84, 0, 0.1); color: #ff8c00; border: 1px solid rgba(211, 84, 0, 0.2); }
    .Gurultu { background: rgba(241, 196, 15, 0.1); color: #f1c40f; border: 1px solid rgba(241, 196, 15, 0.2); }
    .Supheli-Kisi { background: rgba(142, 68, 173, 0.1); color: #a29bfe; border: 1px solid rgba(142, 68, 173, 0.2); }

    .event-desc {
        color: var(--text-s);
        font-size: 0.95rem;
        line-height: 1.6;
        margin: 15px 0;
    }

    .event-meta {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 0.8rem;
        color: var(--text-s);
        border-top: 1px solid var(--border);
        padding-top: 15px;
        margin-top: 15px;
    }

    /* Resimler */
    .img-container {
        margin-top: 15px;
        border-radius: 15px;
        overflow: hidden;
        border: 1px solid var(--border);
        width: fit-content;
    }

    .event-card img {
        max-width: 200px;
        display: block;
        cursor: zoom-in;
        transition: 0.3s;
    }

    .event-card img:hover { opacity: 0.8; }

    /* Butonlar */
    .action-group { display: flex; gap: 10px; margin-top: 20px; }

    .btn {
        padding: 10px 18px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.75rem;
        cursor: pointer;
        border: none;
        transition: 0.3s;
        text-transform: uppercase;
    }

    .btn-pdf { background: var(--success); color: #000; }
    .btn-delete { background: rgba(255, 77, 77, 0.1); color: var(--danger); border: 1px solid rgba(255, 77, 77, 0.2); }
    .btn-delete:hover { background: var(--danger); color: #fff; }

    #logoutBtn {
        background: var(--danger);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
    }

    /* Modal */
    #modal, #deleteModal {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9);
        backdrop-filter: blur(10px); display: none; justify-content: center;
        align-items: center; z-index: 9999; padding: 20px;
    }

    #modalContent {
        background: var(--card-bg);
        border: 1px solid var(--accent);
        padding: 40px;
        border-radius: 30px;
        max-width: 600px;
        width: 100%;
        position: relative;
    }

    .close-modal {
        position: absolute; top: 20px; right: 20px;
        color: #fff; font-size: 1.5rem; cursor: pointer;
    }

    #loadingLayer {
        position: fixed; inset: 0; background: var(--bg); z-index: 10000;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .loader {
        width: 50px; height: 50px; border: 3px solid #161b22;
        border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media(max-width:768px){
        .filters { flex-direction: column; }
        .filters * { width: 100% !important; }
        .header-area { flex-direction: column; gap: 15px; text-align: center; }
    }
</style>
</head>
<body>

<div id="loadingLayer">
    <div class="loader"></div>
    <p style="margin-top:20px; font-weight: 800; color: var(--accent); letter-spacing: 3px;">CGA Sƒ∞STEM Y√úKLENƒ∞YOR</p>
</div>

<div class="header-area">
    <h1>CGA<span>G√úVENLƒ∞K Sƒ∞STEMƒ∞</span></h1>
    <button id="logoutBtn">G√úVENLƒ∞ √áIKI≈û</button>
</div>

<div class="filters">
    <select id="filterUser"><option value="">T√ºm Personeller</option></select>
    <select id="filterType">
        <option value="">T√ºm Olay T√ºrleri</option>
        <option value="Hƒ±rsƒ±zlƒ±k">Hƒ±rsƒ±zlƒ±k</option>
        <option value="G√ºr√ºlt√º">G√ºr√ºlt√º</option>
        <option value="Yangƒ±n">Yangƒ±n</option>
        <option value="≈û√ºpheli Ki≈üi">≈û√ºpheli Ki≈üi</option>
    </select>
    <input type="date" id="filterStart">
    <input type="date" id="filterEnd">
    <button id="resetFilters">Filtreleri Sƒ±fƒ±rla</button>
</div>

<div id="message"></div>
<div id="eventsContainer"></div>

<div id="modal">
    <div id="modalContent">
        <span class="close-modal" id="modalClose">&times;</span>
        <div id="modalText"></div>
    </div>
</div>

<div id="deleteModal">
    <div id="modalContent" style="text-align:center;">
        <h2 style="color:var(--danger)">Olayƒ± Sil?</h2>
        <p id="deleteText" style="color:var(--text-s)"></p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:30px;">
            <button id="confirmDeleteBtn" class="btn" style="background:var(--danger); color:#fff; width:120px;">EVET, Sƒ∞L</button>
            <button id="cancelDeleteBtn" class="btn" style="background:rgba(255,255,255,0.1); color:#fff; width:120px;">ƒ∞PTAL</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const { jsPDF } = window.jspdf;

async function initPage(){
    const merkezConfig = {
        apiKey: "AIzaSyAM5NHBpRHIlttNXwJ9YKDypR4eoyQbDeM",
        authDomain: "kolartguvenlik-e002d.firebaseapp.com",
        databaseURL: "https://kolartguvenlik-e002d-default-rtdb.firebaseio.com",
        projectId: "kolartguvenlik-e002d",
        storageBucket: "kolartguvenlik-e002d.firebasestorage.app",
        appId: "1:212955174898:web:f77501991c1648fb66bd6b"
    };

    const mApp = initializeApp(merkezConfig, "merkez");
    const sId = sessionStorage.getItem("selectedSiteId");
    
    if(!sId) { window.location.href = "sirket.html"; return; }

    const siteSnap = await get(ref(getDatabase(mApp), `sites/${sId}/config`));
    const db = getDatabase(initializeApp(siteSnap.val(), sId));

    const eventsContainer = document.getElementById('eventsContainer');
    const filterUser = document.getElementById('filterUser');
    const filterType = document.getElementById('filterType');
    
    let allEvents = [];
    let selectedEventToDelete = null;

    // Temizleme ve √áƒ±kƒ±≈ü
    document.getElementById('logoutBtn').onclick = () => window.location.href = "sirket.html";
    document.getElementById('resetFilters').onclick = () => {
        document.querySelectorAll('.filters input').forEach(i => i.value = '');
        filterUser.value = ''; filterType.value = '';
        renderEvents();
    };

    function fixChars(str){
        const m = {'√ß':'c','√á':'C','ƒü':'g','ƒû':'G','ƒ±':'i','ƒ∞':'I','√∂':'o','√ñ':'O','≈ü':'s','≈û':'S','√º':'u','√ú':'U'};
        return str.replace(/[√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú]/g, k => m[k]);
    }

    function renderEvents(){
        eventsContainer.innerHTML = '';
        let filtered = allEvents;

        if(filterUser.value) filtered = filtered.filter(e => e.user === filterUser.value);
        if(filterType.value) filtered = filtered.filter(e => e.type === filterType.value);
        
        if(document.getElementById('filterStart').value){
            const s = new Date(document.getElementById('filterStart').value);
            filtered = filtered.filter(e => new Date(e.timestamp) >= s);
        }

        if(filtered.length === 0){
            document.getElementById('message').innerHTML = `<p style="text-align:center; color:var(--text-s); margin-top:50px;">Kayƒ±tlƒ± olay bulunamadƒ±.</p>`;
            return;
        }
        document.getElementById('message').innerHTML = '';
        
        filtered.sort((a,b) => b.timestamp - a.timestamp).forEach(olay => {
            const card = document.createElement('div');
            card.className = 'event-card';
            const tClass = fixChars(olay.type).replace(/\s/g,'-');
            
            card.innerHTML = `
                <div class="event-header">
                    <span class="event-user">${olay.user}</span>
                    <span class="event-type ${tClass}">${olay.type}</span>
                </div>
                <div class="event-desc">${olay.description}</div>
                <div class="event-meta">
                    <span>üìç ${olay.location}</span>
                    <span style="text-align:right;">üìÖ ${olay.date} | ${olay.time}</span>
                </div>
                ${olay.photoData ? `<div class="img-container"><img src="${olay.photoData}" class="zoomImg"></div>` : ''}
                <div class="action-group">
                    <button class="btn btn-pdf">PDF RAPORU</button>
                    <button class="btn btn-delete">Sƒ∞L</button>
                </div>
            `;
            
            card.querySelector('.btn-pdf').onclick = () => savePDF(olay);
            card.querySelector('.btn-delete').onclick = () => {
                selectedEventToDelete = olay;
                document.getElementById('deleteText').innerText = `${olay.type} olay kaydƒ±nƒ± silmek istediƒüinize emin misiniz?`;
                document.getElementById('deleteModal').style.display = 'flex';
            };
            
            if(olay.photoData) {
                card.querySelector('.zoomImg').onclick = () => {
                    document.getElementById('modalText').innerHTML = `<img src="${olay.photoData}" style="width:100%; border-radius:15px;">`;
                    document.getElementById('modal').style.display = 'flex';
                };
            }

            eventsContainer.appendChild(card);
        });
    }

    function savePDF(e){
        const doc = new jsPDF();
        doc.setFont("helvetica", "bold");
        doc.text("CGA GUVENLIK SISTEMI - OLAY RAPORU", 10, 20);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Personel: ${fixChars(e.user)}`, 10, 40);
        doc.text(`Olay: ${fixChars(e.type)}`, 10, 50);
        doc.text(`Tarih: ${e.date} ${e.time}`, 10, 60);
        doc.text(`Konum: ${fixChars(e.location)}`, 10, 70);
        const desc = doc.splitTextToSize(`Aciklama: ${fixChars(e.description)}`, 180);
        doc.text(desc, 10, 85);
        if(e.photoData) doc.addImage(e.photoData, 'JPEG', 10, 110, 100, 75);
        doc.save(`CGA_Rapor_${e.date}.pdf`);
    }

    // Firebase Dinle
    onValue(ref(db, 'securityEvents'), snap => {
        allEvents = [];
        if(snap.exists()){
            const data = snap.val();
            for(let u in data){
                for(let k in data[u]){
                    allEvents.push({...data[u][k], user:u, key:k});
                }
            }
            // Kullanƒ±cƒ± listesini g√ºncelle
            const users = [...new Set(allEvents.map(e => e.user))];
            filterUser.innerHTML = '<option value="">T√ºm Personeller</option>';
            users.forEach(u => filterUser.innerHTML += `<option value="${u}">${u}</option>`);
        }
        renderEvents();
        document.getElementById('loadingLayer').style.display = 'none';
    });

    // Filtre Dinleyiciler
    [filterUser, filterType, document.getElementById('filterStart'), document.getElementById('filterEnd')].forEach(el => {
        el.addEventListener('change', renderEvents);
    });

    // Modal Kapatma
    document.getElementById('modalClose').onclick = () => document.getElementById('modal').style.display = 'none';
    document.getElementById('cancelDeleteBtn').onclick = () => document.getElementById('deleteModal').style.display = 'none';
    document.getElementById('confirmDeleteBtn').onclick = async () => {
        if(selectedEventToDelete){
            await remove(ref(db, `securityEvents/${selectedEventToDelete.user}/${selectedEventToDelete.key}`));
            document.getElementById('deleteModal').style.display = 'none';
        }
    };
}

initPage();
</script>
</body>
</html>