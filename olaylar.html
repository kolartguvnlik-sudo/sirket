<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA GÃœVENLÄ°K | Olay Takip Merkezi</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
    :root { --bg: #0a0c10; --card-bg: #12151c; --accent: #00d2ff; --danger: #ff4d4d; --success: #00ff88; --text: #e6edf3; --text-s: #8b949e; --border: rgba(255, 255, 255, 0.08); }
    body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
    .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
    h1 { margin: 0; font-weight: 800; font-size: 1.5rem; color: var(--accent); }
    .filters { background: var(--card-bg); padding: 20px; border-radius: 20px; display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; border: 1px solid var(--border); }
    .filters select, .filters input { background: #0d1117; border: 1px solid #30363d; color: white; padding: 12px; border-radius: 12px; outline: none; }
    .event-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; padding: 25px; margin-bottom: 20px; transition: 0.4s; }
    .event-card:hover { transform: translateY(-5px); border-color: var(--accent); }
    .event-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .event-user { color: var(--accent); background: rgba(0, 210, 255, 0.1); padding: 5px 12px; border-radius: 8px; font-family: 'JetBrains Mono'; }
    .event-desc { color: var(--text-s); font-size: 0.95rem; line-height: 1.6; margin: 15px 0; }
    .event-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.8rem; border-top: 1px solid var(--border); padding-top: 15px; }
    .btn { padding: 10px 18px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; text-transform: uppercase; }
    .btn-pdf { background: var(--success); color: #000; }
    .btn-delete { background: rgba(255, 77, 77, 0.1); color: var(--danger); border: 1px solid rgba(255, 77, 77, 0.2); }
    #loadingLayer { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .loader { width: 40px; height: 40px; border: 3px solid #161b22; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loadingLayer"><div class="loader"></div><p style="color:var(--accent); margin-top:15px;">CGA SÄ°STEM YÃœKLENÄ°YOR...</p></div>

<div class="header-area">
    <h1>CGA GÃœVENLÄ°K <span>SÄ°STEMÄ°</span></h1>
    <button id="logoutBtn" class="btn" style="background:var(--danger); color:white;">GERÄ°</button>
</div>

<div class="filters">
    <select id="filterUser"><option value="">TÃ¼m Personeller</option></select>
    <select id="filterType">
        <option value="">TÃ¼m Konular</option>
        <option value="KapÄ± aÃ§Ä±k">KAPI AÃ‡IK</option>
        <option value="HÄ±rsÄ±zlÄ±k">HIRSÄ°ZLIK</option>
    </select>
</div>

<div id="eventsContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

async function initPage(){
    const mConfig = {
        apiKey: "AIzaSyAM5NHBpRHIlttNXwJ9YKDypR4eoyQbDeM",
        authDomain: "kolartguvenlik-e002d.firebaseapp.com",
        databaseURL: "https://kolartguvenlik-e002d-default-rtdb.firebaseio.com",
        projectId: "kolartguvenlik-e002d",
        appId: "1:212955174898:web:f77501991c1648fb66bd6b"
    };

    const mApp = initializeApp(mConfig, "merkez");
    const sId = sessionStorage.getItem("selectedSiteId") || "site1"; // Test iÃ§in site1
    const siteSnap = await get(ref(getDatabase(mApp), `sites/${sId}/config`));
    const db = getDatabase(initializeApp(siteSnap.val(), sId));

    const eventsContainer = document.getElementById('eventsContainer');
    const filterUser = document.getElementById('filterUser');
    const filterType = document.getElementById('filterType');
    let allEvents = [];

    document.getElementById('logoutBtn').onclick = () => window.location.href = "sirket.html";

    function formatText(t) {
        if (!t) return "";
        return t.toString().replace(/Ä±/g, 'I').replace(/i/g, 'I').replace(/Ä°/g, 'I').replace(/ÅŸ/g, 'S').replace(/Å/g, 'S').replace(/ÄŸ/g, 'G').replace(/Ä/g, 'G').replace(/Ã¼/g, 'U').replace(/Ãœ/g, 'U').replace(/Ã¶/g, 'O').replace(/Ã–/g, 'O').replace(/Ã§/g, 'C').replace(/Ã‡/g, 'C').toUpperCase();
    }

    // --- SÃœPER AKILLI PDF YAZICI ---
    async function savePDF(olay) {
        try {
            const { PDFDocument } = PDFLib;
            const res = await fetch('sablon.pdf?v=' + Date.now());
            if(!res.ok) throw new Error("sablon.pdf dosyasÄ± bulunamadÄ±!");
            
            const pdfDoc = await PDFDocument.load(await res.arrayBuffer());
            const form = pdfDoc.getForm();
            const fields = form.getFields();

            // TÃ¼m kutularÄ± tara ve isimlerine gÃ¶re veriyi yapÄ±ÅŸtÄ±r
            fields.forEach(field => {
                const name = field.getName().toUpperCase();
                let value = "";

                if (name.includes("R1") || name.includes("RAPOR") || name.includes("SIRA")) value = olay.raporNo;
                else if (name.includes("T3") || name.includes("TARIH")) value = olay.date;
                else if (name.includes("G1") || name.includes("GOREV")) value = olay.location;
                else if (name.includes("T1") || name.includes("TESPIT")) value = olay.tespitYeri;
                else if (name.includes("T2") || name.includes("KONU")) value = olay.konu;
                else if (name.includes("T4") || name.includes("SAAT")) value = olay.time;
                else if (name.includes("A1") || name.includes("ADI")) value = olay.user;
                else if (name.includes("A3") || name.includes("GÃ–REVÄ°")) value = "GUVENLIK GOREVLISI";
                else if (name.includes("Y1") || name.includes("YORUM") || name.includes("DESC")) value = olay.desc;

                if (value && field.constructor.name === 'PDFTextField') {
                    field.setText(formatText(value));
                }
            });

            // FOTOÄRAF (F1)
            if (olay.photoData) {
                try {
                    const img = await pdfDoc.embedJpg(await fetch(olay.photoData).then(r => r.arrayBuffer()));
                    const f1 = form.getTextField('F1');
                    const rect = f1.acroField.getWidgets()[0].getRectangle();
                    pdfDoc.getPages()[0].drawImage(img, { x: rect.x, y: rect.y, width: rect.width, height: rect.height });
                    f1.setText("");
                } catch (e) {}
            }

            const bytes = await pdfDoc.save();
            const blob = new Blob([bytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `CGA_RAPOR_${olay.raporNo}.pdf`;
            link.click();
        } catch (err) { alert("PDF HatasÄ±: " + err.message); }
    }

    function renderEvents(){
        eventsContainer.innerHTML = '';
        let filtered = allEvents;
        if(filterUser.value) filtered = filtered.filter(e => e.user === filterUser.value);
        if(filterType.value) filtered = filtered.filter(e => e.konu === filterType.value);
        
        filtered.sort((a,b) => b.raporNo - a.raporNo).forEach(olay => {
            const card = document.createElement('div');
            card.className = 'event-card';
            card.innerHTML = `
                <div class="event-header"><span class="event-user">${olay.user}</span><span style="font-weight:800;">#${olay.raporNo}</span></div>
                <div class="event-desc">${olay.desc}</div>
                <div class="event-meta"><span>ğŸ“ ${olay.location} / ${olay.tespitYeri}</span><span style="text-align:right;">ğŸ“… ${olay.date} - ${olay.time}</span></div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button class="btn btn-pdf">PDF AL</button>
                    <button class="btn btn-delete">SÄ°L</button>
                </div>
            `;
            card.querySelector('.btn-pdf').onclick = () => savePDF(olay);
            card.querySelector('.btn-delete').onclick = async () => { if(confirm("Silinsin mi?")) await remove(ref(db, `securityEvents/${olay.user}/${olay.key}`)); };
            eventsContainer.appendChild(card);
        });
    }

    onValue(ref(db, 'securityEvents'), snap => {
        allEvents = [];
        if(snap.exists()){
            Object.entries(snap.val()).forEach(([user, events]) => {
                Object.entries(events).forEach(([key, val]) => allEvents.push({...val, user, key}));
            });
            const users = [...new Set(allEvents.map(e => e.user))];
            filterUser.innerHTML = '<option value="">TÃ¼m Personeller</option>' + users.map(u => `<option value="${u}">${u}</option>`).join('');
        }
        renderEvents();
        document.getElementById('loadingLayer').style.display = 'none';
    });

    filterUser.onchange = renderEvents;
    filterType.onchange = renderEvents;
}
initPage();
</script>
</body>
</html>
