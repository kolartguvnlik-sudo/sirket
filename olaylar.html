<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA G√úVENLƒ∞K | Olay Takip Merkezi</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
    :root { --bg: #0a0c10; --card-bg: #12151c; --accent: #00d2ff; --danger: #ff4d4d; --warning: #ffcc00; --success: #00ff88; --text: #e6edf3; --text-s: #8b949e; --border: rgba(255, 255, 255, 0.08); }
    body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--text); padding: 20px; background-image: radial-gradient(circle at top right, rgba(0, 210, 255, 0.05), transparent); }
    .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
    h1 { margin: 0; font-weight: 800; letter-spacing: -1px; text-transform: uppercase; font-size: 1.5rem; color: var(--accent); }
    h1 span { color: #fff; font-weight: 300; margin-left: 5px; opacity: 0.6; }
    .filters { background: var(--card-bg); padding: 20px; border-radius: 20px; display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .filters select, .filters input { background: #0d1117; border: 1px solid #30363d; color: white; padding: 12px; border-radius: 12px; font-family: 'Montserrat'; font-size: 13px; outline: none; transition: 0.3s; }
    .event-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; padding: 25px; margin-bottom: 20px; transition: 0.4s; position: relative; overflow: hidden; }
    .event-card:hover { transform: translateY(-5px); border-color: var(--accent); }
    .event-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .event-user { font-family: 'JetBrains Mono'; color: var(--accent); background: rgba(0, 210, 255, 0.1); padding: 5px 12px; border-radius: 8px; font-size: 0.85rem; }
    .event-type { font-weight: 800; text-transform: uppercase; font-size: 0.7rem; padding: 6px 14px; border-radius: 30px; background: rgba(255,255,255,0.05); }
    .event-desc { color: var(--text-s); font-size: 0.95rem; line-height: 1.6; margin: 15px 0; }
    .event-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.8rem; color: var(--text-s); border-top: 1px solid var(--border); padding-top: 15px; margin-top: 15px; }
    .img-container { margin-top: 15px; border-radius: 15px; overflow: hidden; border: 1px solid var(--border); width: 200px; height: 120px; background: #000; }
    .event-card img { width: 100%; height: 100%; object-fit: cover; cursor: zoom-in; }
    .action-group { display: flex; gap: 10px; margin-top: 20px; }
    .btn { padding: 10px 18px; border-radius: 12px; font-weight: 700; font-size: 0.75rem; cursor: pointer; border: none; transition: 0.3s; text-transform: uppercase; }
    .btn-pdf { background: var(--success); color: #000; }
    .btn-delete { background: rgba(255, 77, 77, 0.1); color: var(--danger); border: 1px solid rgba(255, 77, 77, 0.2); }
    #logoutBtn { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; }
    #modal, #deleteModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
    #modalContent { background: var(--card-bg); border: 1px solid var(--accent); padding: 40px; border-radius: 30px; max-width: 600px; width: 100%; position: relative; }
    .close-modal { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 1.5rem; cursor: pointer; }
    #loadingLayer { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .loader { width: 50px; height: 50px; border: 3px solid #161b22; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loadingLayer">
    <div class="loader"></div>
    <p style="margin-top:20px; font-weight: 800; color: var(--accent); letter-spacing: 3px;">VERƒ∞LER √áEKƒ∞Lƒ∞YOR...</p>
</div>

<div class="header-area">
    <h1>CGA<span>G√úVENLƒ∞K Sƒ∞STEMƒ∞</span></h1>
    <button id="logoutBtn">GERƒ∞</button>
</div>

<div class="filters">
    <select id="filterUser"><option value="">T√ºm Personeller</option></select>
    <select id="filterType">
        <option value="">T√ºm Olay T√ºrleri</option>
        <option value="Hƒ±rsƒ±zlƒ±k">Hƒ±rsƒ±zlƒ±k</option>
        <option value="G√ºr√ºlt√º">G√ºr√ºlt√º</option>
        <option value="Yangƒ±n">Yangƒ±n</option>
        <option value="≈û√ºpheli Ki≈üi">≈û√ºpheli Ki≈üi</option>
    </select>
    <input type="date" id="filterStart">
    <input type="date" id="filterEnd">
    <button id="resetFilters" class="btn" style="background:#30363d; color:white;">Filtreleri Sƒ±fƒ±rla</button>
</div>

<div id="message"></div>
<div id="eventsContainer"></div>

<div id="modal">
    <div id="modalContent">
        <span class="close-modal" id="modalClose">&times;</span>
        <div id="modalText"></div>
    </div>
</div>

<div id="deleteModal">
    <div id="modalContent" style="text-align:center;">
        <h2 style="color:var(--danger)">Olayƒ± Sil?</h2>
        <p style="color:var(--text-s)">Bu i≈ülem geri alƒ±namaz.</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:30px;">
            <button id="confirmDeleteBtn" class="btn" style="background:var(--danger); color:#fff; width:120px;">Sƒ∞L</button>
            <button id="cancelDeleteBtn" class="btn" style="background:rgba(255,255,255,0.1); color:#fff; width:120px;">ƒ∞PTAL</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

let allEvents = [];
let selectedEventToDelete = null;
let db = null;

async function initPage(){
    const merkezConfig = {
        apiKey: "AIzaSyAM5NHBpRHIlttNXwJ9YKDypR4eoyQbDeM",
        authDomain: "kolartguvenlik-e002d.firebaseapp.com",
        databaseURL: "https://kolartguvenlik-e002d-default-rtdb.firebaseio.com",
        projectId: "kolartguvenlik-e002d",
        appId: "1:212955174898:web:f77501991c1648fb66bd6b"
    };

    const mApp = initializeApp(merkezConfig, "merkez");
    const sId = sessionStorage.getItem("selectedSiteId");
    if(!sId) { window.location.href = "sirket.html"; return; }

    try {
        const siteSnap = await get(ref(getDatabase(mApp), `sites/${sId}/config`));
        const siteConfig = siteSnap.val();
        const siteApp = initializeApp(siteConfig, sId);
        db = getDatabase(siteApp);

        // TEK SEFERDE T√úM VERƒ∞Yƒ∞ Dƒ∞NLE (HIZIN KAYNAƒûI)
        onValue(ref(db, 'securityEvents'), snap => {
            allEvents = [];
            if(snap.exists()){
                const data = snap.val();
                for(let u in data){
                    for(let k in data[u]){
                        allEvents.push({...data[u][k], user:u, key:k});
                    }
                }
                updateUserFilter();
            }
            renderEvents();
            document.getElementById('loadingLayer').style.display = 'none';
        });
    } catch (e) {
        console.error(e);
        alert("Baƒülantƒ± hatasƒ±!");
    }
}

function updateUserFilter() {
    const filterUser = document.getElementById('filterUser');
    const users = [...new Set(allEvents.map(e => e.user))];
    const currentVal = filterUser.value;
    filterUser.innerHTML = '<option value="">T√ºm Personeller</option>';
    users.forEach(u => {
        filterUser.innerHTML += `<option value="${u}" ${u === currentVal ? 'selected' : ''}>${u}</option>`;
    });
}

function trToEn(text) {
    if (!text) return "";
    return text.toString()
        .replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'I').replace(/≈ü/g, 's').replace(/≈û/g, 'S')
        .replace(/ƒü/g, 'g').replace(/ƒû/g, 'G').replace(/√º/g, 'u').replace(/√ú/g, 'U')
        .replace(/√∂/g, 'o').replace(/√ñ/g, 'O').replace(/√ß/g, 'c').replace(/√á/g, 'C');
}

async function savePDF(olay) {
    try {
        const { PDFDocument } = PDFLib;
        const resp = await fetch('./sablon.pdf?v=' + Date.now());
        if (!resp.ok) throw new Error("≈ûablon bulunamadƒ±.");
        
        const pdfDoc = await PDFDocument.load(await resp.arrayBuffer());
        const form = pdfDoc.getForm();
        
        const fill = (key, val) => {
            try { form.getTextField(key).setText(trToEn(val)); } catch(e) {}
        };

        fill('R1', olay.raporNo);
        fill('G1', olay.location);
        fill('T1', olay.location);
        fill('T2', olay.konu || olay.type);
        fill('T3', olay.date);
        fill('T4', olay.time);
        fill('A1', olay.user);
        fill('A3', "G√úVENLƒ∞K G√ñREVLƒ∞Sƒ∞");
        fill('Y1', olay.desc || olay.description);

        if (olay.photoData) {
            try {
                const imgBytes = await fetch(olay.photoData).then(r => r.arrayBuffer());
                const img = await pdfDoc.embedJpg(imgBytes);
                const f1 = form.getTextField('F1');
                const rect = f1.acroField.getWidgets()[0].getRectangle();
                pdfDoc.getPages()[0].drawImage(img, { x: rect.x, y: rect.y, width: rect.width, height: rect.height });
                f1.setText("");
            } catch(e) { console.warn("Foto eklenemedi"); }
        }

        const blob = new Blob([await pdfDoc.save()], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `CGA_${olay.raporNo || 'Rapor'}.pdf`;
        link.click();
    } catch (err) { alert("PDF Hatasƒ±: " + err.message); }
}

function renderEvents(){
    const container = document.getElementById('eventsContainer');
    const fUser = document.getElementById('filterUser').value;
    const fType = document.getElementById('filterType').value;
    const fStart = document.getElementById('filterStart').value;
    const fEnd = document.getElementById('filterEnd').value;

    container.innerHTML = '';

    let filtered = allEvents.filter(e => {
        const dateObj = new Date(e.date.split('.').reverse().join('-'));
        return (!fUser || e.user === fUser) &&
               (!fType || (e.konu === fType || e.type === fType)) &&
               (!fStart || dateObj >= new Date(fStart)) &&
               (!fEnd || dateObj <= new Date(fEnd));
    });

    if(filtered.length === 0) {
        document.getElementById('message').innerHTML = '<p style="text-align:center; opacity:0.5;">Kayƒ±t bulunamadƒ±.</p>';
        return;
    }
    document.getElementById('message').innerHTML = '';

    filtered.sort((a,b) => (b.raporNo || 0) - (a.raporNo || 0)).forEach(olay => {
        const card = document.createElement('div');
        card.className = 'event-card';
        card.innerHTML = `
            <div class="event-header">
                <span class="event-user">${olay.user}</span>
                <span class="event-type">${olay.konu || olay.type}</span>
            </div>
            <div class="event-desc">${olay.desc || olay.description || ''}</div>
            <div class="event-meta">
                <span>üìç ${olay.location || '-'}</span>
                <span style="text-align:right;">üìÖ ${olay.date} ${olay.time || ''}</span>
            </div>
            ${olay.photoData ? `<div class="img-container"><img src="${olay.photoData}" loading="lazy" class="zoom"></div>` : ''}
            <div class="action-group">
                <button class="btn btn-pdf">PDF</button>
                <button class="btn btn-delete">Sƒ∞L</button>
            </div>
        `;
        
        card.querySelector('.btn-pdf').onclick = () => savePDF(olay);
        card.querySelector('.btn-delete').onclick = () => {
            selectedEventToDelete = olay;
            document.getElementById('deleteModal').style.display = 'flex';
        };
        if(olay.photoData) {
            card.querySelector('.zoom').onclick = () => {
                document.getElementById('modalText').innerHTML = `<img src="${olay.photoData}" style="width:100%; border-radius:15px;">`;
                document.getElementById('modal').style.display = 'flex';
            };
        }
        container.appendChild(card);
    });
}

// Olay Dinleyiciler
document.getElementById('logoutBtn').onclick = () => window.location.href = "sirket.html";
document.getElementById('
