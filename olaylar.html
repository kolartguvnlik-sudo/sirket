<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA GÜVENLİK | KESİN ÇÖZÜM</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">

<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>

<style>
    :root { --bg: #0a0c10; --card-bg: #12151c; --accent: #00d2ff; --text: #e6edf3; --border: rgba(255, 255, 255, 0.08); }
    body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
    .event-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 15px; padding: 20px; margin-bottom: 15px; }
    .btn-pdf { background: #00ff88; color: #000; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; }
    #loadingLayer { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; justify-content: center; align-items: center; }
</style>
</head>
<body>

<div id="loadingLayer">
    <h2 style="color:var(--accent)">SİSTEM YÜKLENİYOR...</h2>
</div>

<div class="header">
    <h1>CGA <span>GÜVENLİK</span></h1>
    <button onclick="location.href='sirket.html'" style="background:#ff4d4d; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">GERİ</button>
</div>

<div id="eventsContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

async function initPage(){
    const merkezConfig = {
        apiKey: "AIzaSyAM5NHBpRHIlttNXwJ9YKDypR4eoyQbDeM",
        authDomain: "kolartguvenlik-e002d.firebaseapp.com",
        databaseURL: "https://kolartguvenlik-e002d-default-rtdb.firebaseio.com",
        projectId: "kolartguvenlik-e002d",
        appId: "1:212955174898:web:f77501991c1648fb66bd6b"
    };

    const mApp = initializeApp(merkezConfig, "merkez");
    const sId = sessionStorage.getItem("selectedSiteId");
    if(!sId) { window.location.href = "sirket.html"; return; }

    const siteSnap = await get(ref(getDatabase(mApp), `sites/${sId}/config`));
    const db = getDatabase(initializeApp(siteSnap.val(), sId));

    // --- PDF FONKSİYONU ---
    window.savePDF = async (olay) => {
        try {
            console.log("PDF Hazırlanıyor...");
            const { PDFDocument, rgb } = PDFLib;
            
            // Font ve Şablon Yükleme
            const fontUrl = './font.ttf'; // Kendi fontun
            const pdfUrl = './sablon.pdf'; // Kendi şablonun

            const fontBytes = await fetch(fontUrl).then(res => {
                if(!res.ok) throw new Error("font.ttf dosyası klasörde bulunamadı!");
                return res.arrayBuffer();
            });
            const pdfBytes = await fetch(pdfUrl).then(res => {
                if(!res.ok) throw new Error("sablon.pdf dosyası bulunamadı!");
                return res.arrayBuffer();
            });

            const pdfDoc = await PDFDocument.load(pdfBytes);
            
            // FONTKIT KAYDI (Hata Almamak İçin Window üzerinden kontrol)
            if (window.fontkit) {
                pdfDoc.registerFontkit(window.fontkit);
            } else {
                throw new Error("Fontkit kütüphanesi yüklenemedi!");
            }

            const customFont = await pdfDoc.embedFont(fontBytes);
            const form = pdfDoc.getForm();
            const page = pdfDoc.getPages()[0];

            const mapping = {
                'P1': olay.raporNo, 'Z1': olay.raporNo, 'SIRA': olay.raporNo,
                'P2': olay.date, 'Z3': olay.date, 'G1': olay.location,
                'T1': olay.tespitYeri, 'T2': olay.konu, 'T4': olay.time,
                'A1': olay.user, 'A3': "GÜVENLİK GÖREVLİSİ", 'Y1': olay.desc
            };

            const fields = form.getFields();
            fields.forEach(field => {
                const name = field.getName();
                if (mapping[name] !== undefined) {
                    try {
                        const textField = form.getTextField(name);
                        // TÜRKÇE KARAKTERLERİN ÇIKMASI İÇİN KRİTİK 2 SATIR:
                        textField.setText(mapping[name].toString());
                        textField.updateAppearances(customFont);
                    } catch (e) {
                        console.warn(name + " için çizim yapılıyor...");
                    }
                }
            });

            // FOTOĞRAF
            if (olay.photoData) {
                try {
                    const img = await pdfDoc.embedJpg(await fetch(olay.photoData).then(r => r.arrayBuffer()));
                    const f1 = form.getTextField('F1');
                    const rect = f1.acroField.getWidgets()[0].getRectangle();
                    page.drawImage(img, { x: rect.x, y: rect.y, width: rect.width, height: rect.height });
                } catch(e) { console.error("Foto basılamadı"); }
            }

            form.flatten();
            const savedBytes = await pdfDoc.save();
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([savedBytes], { type: 'application/pdf' }));
            link.download = `RAPOR_${olay.raporNo}.pdf`;
            link.click();
            console.log("PDF Başarıyla indirildi.");

        } catch (err) {
            console.error(err);
            alert("Hata: " + err.message);
        }
    };

    // --- VERİ LİSTELEME ---
    onValue(ref(db, 'securityEvents'), snap => {
        const container = document.getElementById('eventsContainer');
        container.innerHTML = '';
        if(snap.exists()){
            const data = snap.val();
            for(let u in data){
                for(let k in data[u]){
                    const olay = {...data[u][k], user:u};
                    const card = document.createElement('div');
                    card.className = 'event-card';
                    card.innerHTML = `
                        <h3>${olay.user} - ${olay.konu}</h3>
                        <p>${olay.desc}</p>
                        <button class="btn-pdf" onclick="window.savePDF(${JSON.stringify(olay).replace(/"/g, '&quot;')})">PDF RAPORU AL</button>
                    `;
                    container.appendChild(card);
                }
            }
        }
        document.getElementById('loadingLayer').style.display = 'none';
    });
}
initPage();
</script>
</body>
</html>
