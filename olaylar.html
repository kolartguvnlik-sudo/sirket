<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CGA GÜVENLİK SİSTEMİ | KESİN ÇÖZÜM</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        :root { --bg: #0a0c10; --card-bg: #12151c; --accent: #00d2ff; --success: #00ff88; --text: #e6edf3; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 30px; }
        .event-card { background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; margin-bottom: 15px; }
        .btn { background: var(--success); color: #000; border: none; padding: 12px 25px; border-radius: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        #loading { position: fixed; inset: 0; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 999; font-weight: bold; color: var(--accent); }
    </style>
</head>
<body>

<div id="loading">SİSTEM YÜKLENİYOR... LÜTFEN BEKLEYİN</div>
<h1 style="color:var(--accent); text-transform: uppercase;">CGA Durum Tespit Paneli</h1>
<hr style="opacity: 0.1; margin-bottom: 30px;">
<div id="eventsContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const mConfig = {
    apiKey: "AIzaSyAM5NHBpRHIlttNXwJ9YKDypR4eoyQbDeM",
    authDomain: "kolartguvenlik-e002d.firebaseapp.com",
    databaseURL: "https://kolartguvenlik-e002d-default-rtdb.firebaseio.com",
    projectId: "kolartguvenlik-e002d",
    appId: "1:212955174898:web:f77501991c1648fb66bd6b"
};

async function start() {
    const mApp = initializeApp(mConfig, "merkez");
    const sId = sessionStorage.getItem("selectedSiteId") || "site1";
    const siteSnap = await get(ref(getDatabase(mApp), `sites/${sId}/config`));
    const db = getDatabase(initializeApp(siteSnap.val(), sId));

    function formatUpper(t) {
        if (!t) return "";
        return t.toString().replace(/ı/g, 'I').replace(/i/g, 'I').replace(/İ/g, 'I').replace(/ş/g, 'S').replace(/Ş/g, 'S').replace(/ğ/g, 'G').replace(/Ğ/g, 'G').replace(/ü/g, 'U').replace(/Ü/g, 'U').replace(/ö/g, 'O').replace(/Ö/g, 'O').replace(/ç/g, 'C').replace(/Ç/g, 'C').toUpperCase();
    }

    async function generatePDF(olay) {
        try {
            const { PDFDocument } = PDFLib;
            const res = await fetch('sablon.pdf?v=' + Date.now());
            const pdfDoc = await PDFDocument.load(await res.arrayBuffer());
            const form = pdfDoc.getForm();
            const allFields = form.getFields(); // PDF içindeki her şeyi al

            // --- EŞLEŞTİRME HARİTASI ---
            const dataMap = {
                'R1': olay.raporNo,
                'SIRA': olay.raporNo,
                'G1': olay.location,
                'T1': olay.tespitYeri,
                'T2': olay.konu,
                'T3': olay.date,
                'T4': olay.time,
                'A1': olay.user,
                'A3': "GUVENLIK GOREVLISI",
                'Y1': olay.desc
            };

            // --- ÇÖZÜM: TÜM ALANLARI DÖNGÜYE SOK ---
            allFields.forEach(field => {
                const fieldName = field.getName(); // PDF'deki alanın adı
                // Eğer bizim dataMap'imizde bu isimde bir veri varsa (R1, T3 vb.)
                if (dataMap[fieldName] !== undefined) {
                    try {
                        const textField = form.getTextField(fieldName);
                        textField.setText(formatUpper(dataMap[fieldName]));
                    } catch (e) {
                        console.log(`${fieldName} alanı yazılamadı, muhtemelen metin kutusu değil.`);
                    }
                }
            });

            // FOTOĞRAF (F1)
            if (olay.photoData) {
                try {
                    const img = await pdfDoc.embedJpg(await fetch(olay.photoData).then(r => r.arrayBuffer()));
                    const f1 = form.getTextField('F1');
                    const rect = f1.acroField.getWidgets()[0].getRectangle();
                    pdfDoc.getPages()[0].drawImage(img, { x: rect.x, y: rect.y, width: rect.width, height: rect.height });
                    f1.setText("");
                } catch (e) { console.error("Fotoğraf hatası"); }
            }

            const bytes = await pdfDoc.save();
            const blob = new Blob([bytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `CGA_Rapor_${olay.raporNo}.pdf`;
            link.click();
        } catch (err) { alert("Hata: " + err.message); }
    }

    onValue(ref(db, 'securityEvents'), snap => {
        const cont = document.getElementById('eventsContainer');
        cont.innerHTML = '';
        document.getElementById('loading').style.display = 'none';
        
        if(snap.exists()){
            Object.entries(snap.val()).forEach(([user, events]) => {
                Object.entries(events).forEach(([key, val]) => {
                    const olay = {...val, user, key};
                    const div = document.createElement('div');
                    div.className = 'event-card';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <strong style="color:var(--accent); font-size:1.2rem;">#${olay.raporNo} - ${olay.konu}</strong><br>
                                <small>Tarih: ${olay.date} | Personel: ${olay.user}</small>
                            </div>
                            <button class="btn">PDF OLUŞTUR</button>
                        </div>
                        <p style="margin-top:15px; opacity:0.8;">${olay.desc}</p>
                    `;
                    div.querySelector('button').onclick = () => generatePDF(olay);
                    cont.appendChild(div);
                });
            });
        }
    });
}
start();
</script>
</body>
</html>
