<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CGA GÜVENLİK | ELITE PDF PANEL</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <style>
        :root { --bg: #0a0c10; --accent: #00d2ff; --card-bg: #12151c; --text: #e6edf3; --border: rgba(255, 255, 255, 0.08); }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 20px; }
        .event-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 15px; padding: 20px; margin-bottom: 15px; }
        .btn-pdf { background: #00ff88; color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        #loading { position: fixed; inset: 0; background: #000; display: flex; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="loading"><b>SİSTEM VE FONT YÜKLENİYOR...</b></div>

<div class="header">
    <h1>CGA <span>SİSTEM</span></h1>
    <button onclick="location.href='sirket.html'" style="background:red; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">GERİ</button>
</div>

<div id="eventsContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// ELİT ÇÖZÜM: Türkçe Karakter Destekli Font (Roboto-Regular) Base64 Formatında
// Bu sayede "Font formatı bilinmiyor" hatası almazsın, karakterler asla bozulmaz.
const ROBOTO_BASE64 = "AAEAAAARAQAABAAQR0RFRgAEAAYAAAGcAAAAQkdQT1MAAAAAAAABpAAAACR0U1VCAAAAAAABtAAAAAhPUy8yAAAByAAAAGAAAABgVlMvMgAAAcgAAABgAAAAYGNtYXAAAAHIAAABgAAAAYBnYXNwAAAAHIAAABgAAAAYZ2x5ZgAAAcgAAABgAAAAYGhlYWQAAAcgAAABgAAAAYNoaGVhAAAHIAAAAGAAAAAkaG10eAAAHIAAAAGAAAAAYGxvY2EAAAcgAAABgAAAAYBtYXhwAAAHIAAAAGAAAAAYbmFtZAAAHIAAAAGAAAAAYHBvc3QAAAcgAAABgAAAAYAAAAABAAAAAMuS7mEAAAAA"; 
// (Not: Yukarıdaki Base64 örnektir, tam kodda çalışması için fontu tam gömmek gerekir. Ancak senin için çalışan CDN linkini en sağlam yolla entegre ettim aşağıda.)

async function initPage(){
    const merkezConfig = {
        apiKey: "AIzaSyAM5NHBpRHIlttNXwJ9YKDypR4eoyQbDeM",
        authDomain: "kolartguvenlik-e002d.firebaseapp.com",
        databaseURL: "https://kolartguvenlik-e002d-default-rtdb.firebaseio.com",
        projectId: "kolartguvenlik-e002d",
        appId: "1:212955174898:web:f77501991c1648fb66bd6b"
    };

    const mApp = initializeApp(merkezConfig, "merkez");
    const sId = sessionStorage.getItem("selectedSiteId");
    const siteSnap = await get(ref(getDatabase(mApp), `sites/${sId}/config`));
    const db = getDatabase(initializeApp(siteSnap.val(), sId));

    // --- PDF KAYDETME FONKSİYONU (ELITE EDITION) ---
    window.savePDF = async (olay) => {
        try {
            const { PDFDocument, rgb } = PDFLib;
            const res = await fetch('sablon.pdf?v=' + Date.now());
            if(!res.ok) throw new Error("Şablon bulunamadı!");
            
            const pdfDoc = await PDFDocument.load(await res.arrayBuffer());
            pdfDoc.registerFontkit(window.fontkit);

            // TÜRKÇE KARAKTERLERİN ANAHTARI BURASI:
            const fontBytes = await fetch('https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxP.ttf').then(r => r.arrayBuffer());
            const customFont = await pdfDoc.embedFont(fontBytes);

            const form = pdfDoc.getForm();
            const pages = pdfDoc.getPages();
            const page = pages[0];

            const data = {
                'P1': olay.raporNo, 'Z1': olay.raporNo, 'SIRA': olay.raporNo,
                'P2': olay.date, 'Z3': olay.date, 'G1': olay.location,
                'T1': olay.tespitYeri, 'T2': olay.konu, 'T4': olay.time,
                'A1': olay.user, 'A3': "GÜVENLİK GÖREVLİSİ", 'Y1': olay.desc
            };

            const fields = form.getFields();
            fields.forEach(field => {
                const name = field.getName();
                if (data[name]) {
                    // FORM DOLDURURKEN TÜRKÇE KARAKTERLERİ BASALIM
                    try {
                        const textField = form.getTextField(name);
                        textField.setText(data[name].toString().toUpperCase());
                        // BURASI ÇOK ÖNEMLİ: Fontu her alana tek tek zorla!
                        textField.updateAppearances(customFont);
                    } catch(e) {
                        // Eğer form doldurma hata verirse üzerine "ÇİZ" (Garantici yöntem)
                        const widgets = field.acroField.getWidgets();
                        if(widgets.length > 0) {
                            const rect = widgets[0].getRectangle();
                            page.drawText(data[name].toString().toUpperCase(), {
                                x: rect.x + 2, y: rect.y + 2,
                                size: 9, font: customFont, color: rgb(0,0,0)
                            });
                        }
                    }
                }
            });

            // FOTOĞRAF EKLEME
            if (olay.photoData) {
                try {
                    const img = await pdfDoc.embedJpg(await fetch(olay.photoData).then(r => r.arrayBuffer()));
                    const f1Field = form.getTextField('F1');
                    const rect = f1Field.acroField.getWidgets()[0].getRectangle();
                    page.drawImage(img, { x: rect.x, y: rect.y, width: rect.width, height: rect.height });
                } catch(e) { console.log("Foto hatası"); }
            }

            form.flatten(); // Formu kilitle (Karakterlerin uçmasını engeller)
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `RAPOR_${olay.raporNo}.pdf`;
            link.click();

        } catch (err) { alert("Hata oluştu: " + err.message); }
    };

    onValue(ref(db, 'securityEvents'), snap => {
        const container = document.getElementById('eventsContainer');
        container.innerHTML = '';
        if(snap.exists()){
            const data = snap.val();
            for(let u in data){
                for(let k in data[u]){
                    const olay = {...data[u][k], user:u};
                    const card = document.createElement('div');
                    card.className = 'event-card';
                    card.innerHTML = `
                        <h3>${olay.konu} - ${olay.user}</h3>
                        <p>${olay.desc}</p>
                        <button class="btn-pdf" id="btn-${k}">PDF RAPORU AL</button>
                    `;
                    container.appendChild(card);
                    document.getElementById(`btn-${k}`).onclick = () => window.savePDF(olay);
                }
            }
        }
        document.getElementById('loading').style.display = 'none';
    });
}

initPage();
</script>
</body>
</html>
